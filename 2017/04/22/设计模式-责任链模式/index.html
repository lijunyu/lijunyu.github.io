<!DOCTYPE html>
<html>
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.2.6 -->

    <!-- Title -->
    
    <title>
        
            设计模式-责任链模式 | 
        
        八月份的饺子
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Yoo">
    <meta name="description" content="一句话介绍不清楚自己">
    <meta name="keywords" content="null">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="八月份的饺子">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://lijunyu.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="设计模式-责任链模式 | 八月份的饺子">
    <meta property="og:description" content="一句话介绍不清楚自己">

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
    body, html {
        font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    }

    a {
        color: #00838F;
    }

    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important;
    }

    /* Sidebar User Drop Down Menu Text Color */
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
        color: #0097A7 !important;
    }

    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
        color: #0097A7 !important;
    }

    .toTop {
        background: #757575 !important;
    }

    .material-layout .material-post>.material-nav,
    .material-layout .material-index>.material-nav,
    .material-nav a {
        color: #757575;
    }

    #scheme-Paradox .MD-burger-layer {
        background-color: #757575;
    }

    #scheme-Paradox #post-toc-trigger-btn {
        color: #757575;
    }

    .post-toc a:hover {
        color: #00838F;
        text-decoration: underline;
    }
</style>


<!-- Theme Background Related-->

    <style>
        body{
            background-image: url(/img/bg.png);
        }
    </style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>


    <script src="/js/jquery.min.js"></script>

    <link rel="stylesheet" href="/css/highlight/solarized-white.css">

    <!-- UC Browser Compatible-->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write('<link rel="stylesheet" href="/css/uc.css">');
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#从击鼓传花谈起"><span class="post-toc-number">1.</span> <span class="post-toc-text">从击鼓传花谈起</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#责任链模式的结构"><span class="post-toc-number">2.</span> <span class="post-toc-text">责任链模式的结构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用场景"><span class="post-toc-number">3.</span> <span class="post-toc-text">使用场景</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#源代码"><span class="post-toc-number">4.</span> <span class="post-toc-text">源代码</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#纯的与不纯的责任链模式"><span class="post-toc-number">5.</span> <span class="post-toc-text">纯的与不纯的责任链模式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#责任链模式在Tomcat中的应用"><span class="post-toc-number">6.</span> <span class="post-toc-text">责任链模式在Tomcat中的应用</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                设计模式-责任链模式
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar/me.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Yoo</strong>
        <span>4月 22, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
            <i class="material-icons" role="presentation">devices other</i>
            <span class="visuallyhidden">devices other</span>
        </button>
        <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
            <li class="mdl-menu__item">在其它设备中阅读本文章</li>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAAC2klEQVR42u3abU7rMBAFUPa/ad4Cqhfu9RjR2se/EE1inyAxnY+v7yvXFzY2NjY2NjY2NvZbsr/i9Xr9fzd4+bS96/n69szY2NjYN7B/+Nf/cqBk+8m9z6+gPTM2Njb2Pezk6MkGz1fOg9nambGxsbGxn5OE58CTgIukAhsbGxt7/oggbWg/ba/BxsbGxh4VaMqiT/tCn8/2B7U0bGxs7Ldnt8X6d/j5D/rb2NjY2G/JblebTrRPnjR3f3g+NjY29qHsZLNJeShpISRpySQ1wsbGxj6bnQSqnJo3g9eQa+0EbGxs7BvYeehKjpinEHkZKw97RQaGjY2NfQE7D0t5OrE2rDMvXWFjY2Ofyk5uzr/uJ4WeCTtPkIr+NjY2NvaHs3e1Wts2w97RnFF7ABsbG/sIdp5OTApMdRkoTmyic2JjY2Mfyp48aO369t62YVwUlbCxsbEPYuclnt8btUk+Ta7HxsbGvpPdFpIWQ0hQPGoTkmLMCBsbG/tQdrJBHmySVvH30tpQzMLGxsY+mj1JJ9YSmF28PKBiY2Njn8qObohDVBL22nLVtgQGGxsb+1B2njy045XzV7A2+hm1B7CxsbGPY+eN1ZY6KgOVY6B1AMPGxsY+iJ0nJ21wagtSeZKTNzCwsbGxb2DnqcIEPykV5X+GzXEbGxsb+0PYa1/0J+M7a09b+w02Njb2Deyk3JOX8tfSm3wEZ3Mqgo2Njf3h7LaVuxaQ8nvzVadA2NjY2Iey5w3XteJ+Pjq5FkSxsbGx72TvChttitKmH5vbA9jY2Ngfzt4QGOJ0Iinit62LoqWBjY2NfTR7smU7ypO3IpIXVLSNsbGxsS9gzwco8zHK/MXlgRYbGxsbO2G3ozn5OE4b5DYUlbCxsbEvZq+V/ieN4fzJdVEJGxsb+yB2AvjtpsJacoKNjY2NPSnZ5MGsDX5tQK2LStjY2NhHsO9Z2NjY2NjY2NjY2G+z/gHLrwGTJk5V3QAAAABJRU5ErkJggg==">
        </ul>
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/java/">java</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/设计模式/">设计模式</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    <!-- Leancloud Views -->
        <a class="post_share-link" href="#">
            <li class="mdl-menu__item">
                <span id="/2017/04/22/设计模式-责任链模式/" class="leancloud-views_num" data-flag-title="设计模式-责任链模式">
     &nbsp;浏览量
</span>

            </li>
        </a>
    

    
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=设计模式-责任链模式&url=https://lijunyu.github.io//2017/04/22/设计模式-责任链模式/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=设计模式-责任链模式&url=https://lijunyu.github.io//2017/04/22/设计模式-责任链模式/index.html&via=Yoo" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://lijunyu.github.io//2017/04/22/设计模式-责任链模式/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://lijunyu.github.io//2017/04/22/设计模式-责任链模式/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=八月份的饺子&title=设计模式-责任链模式&summary=一句话介绍不清楚自己&pics=https://lijunyu.github.io/img/favicon.png&url=https://lijunyu.github.io/2017/04/22/设计模式-责任链模式/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <script src="/assets/js/APlayer.min.js"> </script><script src="/assets/js/DPlayer.min.js"> </script><p>　　被别人问到，自己只知道这个名字，但是完全不知道内容，竟然还是这么常用的设计的模式，丢人啊，然后找到一篇，介绍简单好理解的文章，转过来。<br>　　<a href="http://www.cnblogs.com/java-my-life/archive/2012/05/28/2516865.html" target="_blank" rel="external">【原文】《JAVA与模式》之责任链模式</a><br>　　在阎宏博士的《JAVA与模式》一书中开头是这样描述责任链（Chain of Responsibility）模式的：<br><strong>      责任链模式是一种对象的行为模式。在责任链模式里，很多对象由每一个对象对其下家的引用而连接起来形成一条链。请求在这个链上传递，直到链上的某一个对象决定处理此请求。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织和分配责任。</strong><br>　　作者举了一个击鼓传花的例子，甚是形象</p>
<h3 id="从击鼓传花谈起"><a href="#从击鼓传花谈起" class="headerlink" title="从击鼓传花谈起"></a>从击鼓传花谈起</h3><p>　　击鼓传花是一种热闹而又紧张的饮酒游戏。在酒宴上宾客依次坐定位置，由一人击鼓，击鼓的地方与传花的地方是分开的，以示公正。开始击鼓时，花束就开始依次传递，鼓声一落，如果花束在某人手中，则该人就得饮酒。<br>　　比如说，贾母、贾赦、贾政、贾宝玉和贾环是五个参加击鼓传花游戏的传花者，他们组成一个环链。击鼓者将花传给贾母，开始传花游戏。花由贾母传给贾赦，由贾赦传给贾政，由贾政传给贾宝玉，又贾宝玉传给贾环，由贾环传回给贾母，如此往复，如下图所示。当鼓声停止时，手中有花的人就得执行酒令。<br><img src="http://upload-images.jianshu.io/upload_images/331652-9a178abc0595a241.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>　　击鼓传花便是责任链模式的应用。责任链可能是一条直线、一个环链或者一个树结构的一部分。</p>
<h3 id="责任链模式的结构"><a href="#责任链模式的结构" class="headerlink" title="责任链模式的结构"></a>责任链模式的结构</h3><p>　　下面使用了一个责任链模式的最简单的实现。<br><img src="http://upload-images.jianshu.io/upload_images/331652-6f5e90cbbbf023bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>责任链模式涉及到的角色如下所示：<br>●<strong>抽象处理者(Handler)角色：</strong>定义出一个处理请求的接口。如果需要，接口可以定义 出一个方法以设定和返回对下家的引用。这个角色通常由一个Java抽象类或者Java接口实现。上图中Handler类的聚合关系给出了具体子类对下家的引用，抽象方法handleRequest()规范了子类处理请求的操作。<br>●<strong>具体处理者(ConcreteHandler)角色：</strong>具体处理者接到请求后，可以选择将请求处理掉，或者将请求传给下家。由于具体处理者持有对下家的引用，因此，如果需要，具体处理者可以访问下家。<br>源代码<br>抽象处理者角色</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public abstract class Handler &#123;</div><div class="line">    /**</div><div class="line">     * 持有后继的责任对象</div><div class="line">     */</div><div class="line">    protected Handler successor;</div><div class="line">    /**</div><div class="line">     * 示意处理请求的方法，虽然这个示意方法是没有传入参数的</div><div class="line">     * 但实际是可以传入参数的，根据具体需要来选择是否传递参数</div><div class="line">     */</div><div class="line">    public abstract void handleRequest();</div><div class="line">    /**</div><div class="line">     * 取值方法</div><div class="line">     */</div><div class="line">    public Handler getSuccessor() &#123;</div><div class="line">        return successor;</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     * 赋值方法，设置后继的责任对象</div><div class="line">     */</div><div class="line">    public void setSuccessor(Handler successor) &#123;</div><div class="line">        this.successor = successor;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体处理者角色</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class ConcreteHandler extends Handler &#123;</div><div class="line">    /**</div><div class="line">     * 处理方法，调用此方法处理请求</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    public void handleRequest() &#123;</div><div class="line">        /**</div><div class="line">         * 判断是否有后继的责任对象</div><div class="line">         * 如果有，就转发请求给后继的责任对象</div><div class="line">         * 如果没有，则处理请求</div><div class="line">         */</div><div class="line">        if(getSuccessor() != null)</div><div class="line">        &#123;            </div><div class="line">            System.out.println(&quot;放过请求&quot;);</div><div class="line">            getSuccessor().handleRequest();            </div><div class="line">        &#125;else</div><div class="line">        &#123;            </div><div class="line">            System.out.println(&quot;处理请求&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class Client &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //组装责任链</div><div class="line">        Handler handler1 = new ConcreteHandler();</div><div class="line">        Handler handler2 = new ConcreteHandler();</div><div class="line">        handler1.setSuccessor(handler2);</div><div class="line">        //提交请求</div><div class="line">        handler1.handleRequest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>　　可以看出，客户端创建了两个处理者对象，并指定第一个处理者对象的下家是第二个处理者对象，而第二个处理者对象没有下家。然后客户端将请求传递给第一个处理者对象。</p>
<p>　　由于本示例的传递逻辑非常简单：只要有下家，就传给下家处理；如果没有下家，就自行处理。因此，第一个处理者对象接到请求后，会将请求传递给第二个处理者对象。由于第二个处理者对象没有下家，于是自行处理请求。活动时序图如下所示。<br><img src="http://upload-images.jianshu.io/upload_images/331652-a1272c7c50c1b847.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>　　来考虑这样一个功能:申请聚餐费用的管理。</p>
<p>　　很多公司都是这样的福利，就是项目组或者是部门可以向公司申请一些聚餐费用，用于组织项目组成员或者是部门成员进行聚餐活动。</p>
<p>　　申请聚餐费用的大致流程一般是：由申请人先填写申请单，然后交给领导审批，如果申请批准下来，领导会通知申请人审批通过，然后申请人去财务领取费用，如果没有批准下来，领导会通知申请人审批未通过，此事也就此作罢。</p>
<p>　　不同级别的领导，对于审批的额度是不一样的，比如，项目经理只能审批500元以内的申请；部门经理能审批1000元以内的申请；而总经理可以审核任意额度的申请。</p>
<p>　　也就是说，当某人提出聚餐费用申请的请求后，该请求会经由项目经理、部门经理、总经理之中的某一位领导来进行相应的处理，但是提出申请的人并不知道最终会由谁来处理他的请求，一般申请人是把自己的申请提交给项目经理，或许最后是由总经理来处理他的请求。</p>
<p>　　可以使用责任链模式来实现上述功能：当某人提出聚餐费用申请的请求后，该请求会在 项目经理—〉部门经理—〉总经理 这样一条领导处理链上进行传递，发出请求的人并不知道谁会来处理他的请求，每个领导会根据自己的职责范围，来判断是处理请求还是把请求交给更高级别的领导，只要有领导处理了，传递就结束了。</p>
<p>　　需要把每位领导的处理独立出来，实现成单独的职责处理对象，然后为它们提供一个公共的、抽象的父职责对象，这样就可以在客户端来动态地组合职责链，实现不同的功能要求了。<br><img src="http://upload-images.jianshu.io/upload_images/331652-ab904833c6d00280.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>抽象处理者角色类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public abstract class Handler &#123;</div><div class="line">    /**</div><div class="line">     * 持有下一个处理请求的对象</div><div class="line">     */</div><div class="line">    protected Handler successor = null;</div><div class="line">    /**</div><div class="line">     * 取值方法</div><div class="line">     */</div><div class="line">    public Handler getSuccessor() &#123;</div><div class="line">        return successor;</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     * 设置下一个处理请求的对象</div><div class="line">     */</div><div class="line">    public void setSuccessor(Handler successor) &#123;</div><div class="line">        this.successor = successor;</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     * 处理聚餐费用的申请</div><div class="line">     * @param user    申请人</div><div class="line">     * @param fee    申请的钱数</div><div class="line">     * @return        成功或失败的具体通知</div><div class="line">     */</div><div class="line">    public abstract String handleFeeRequest(String user , double fee);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体处理者角色</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class ProjectManager extends Handler &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String handleFeeRequest(String user, double fee) &#123;</div><div class="line">        </div><div class="line">        String str = &quot;&quot;;</div><div class="line">        //项目经理权限比较小，只能在500以内</div><div class="line">        if(fee &lt; 500)</div><div class="line">        &#123;</div><div class="line">            //为了测试，简单点，只同意张三的请求</div><div class="line">            if(&quot;张三&quot;.equals(user))</div><div class="line">            &#123;</div><div class="line">                str = &quot;成功：项目经理同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;    </div><div class="line">            &#125;else</div><div class="line">            &#123;</div><div class="line">                //其他人一律不同意</div><div class="line">                str = &quot;失败：项目经理不同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125;else</div><div class="line">        &#123;</div><div class="line">            //超过500，继续传递给级别更高的人处理</div><div class="line">            if(getSuccessor() != null)</div><div class="line">            &#123;</div><div class="line">                return getSuccessor().handleFeeRequest(user, fee);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class DeptManager extends Handler &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String handleFeeRequest(String user, double fee) &#123;</div><div class="line">        </div><div class="line">        String str = &quot;&quot;;</div><div class="line">        //部门经理的权限只能在1000以内</div><div class="line">        if(fee &lt; 1000)</div><div class="line">        &#123;</div><div class="line">            //为了测试，简单点，只同意张三的请求</div><div class="line">            if(&quot;张三&quot;.equals(user))</div><div class="line">            &#123;</div><div class="line">                str = &quot;成功：部门经理同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;    </div><div class="line">            &#125;else</div><div class="line">            &#123;</div><div class="line">                //其他人一律不同意</div><div class="line">                str = &quot;失败：部门经理不同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125;else</div><div class="line">        &#123;</div><div class="line">            //超过1000，继续传递给级别更高的人处理</div><div class="line">            if(getSuccessor() != null)</div><div class="line">            &#123;</div><div class="line">                return getSuccessor().handleFeeRequest(user, fee);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class GeneralManager extends Handler &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String handleFeeRequest(String user, double fee) &#123;</div><div class="line">        </div><div class="line">        String str = &quot;&quot;;</div><div class="line">        //总经理的权限很大，只要请求到了这里，他都可以处理</div><div class="line">        if(fee &gt;= 1000)</div><div class="line">        &#123;</div><div class="line">            //为了测试，简单点，只同意张三的请求</div><div class="line">            if(&quot;张三&quot;.equals(user))</div><div class="line">            &#123;</div><div class="line">                str = &quot;成功：总经理同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;    </div><div class="line">            &#125;else</div><div class="line">            &#123;</div><div class="line">                //其他人一律不同意</div><div class="line">                str = &quot;失败：总经理不同意【&quot; + user + &quot;】的聚餐费用，金额为&quot; + fee + &quot;元&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125;else</div><div class="line">        &#123;</div><div class="line">            //如果还有后继的处理对象，继续传递</div><div class="line">            if(getSuccessor() != null)</div><div class="line">            &#123;</div><div class="line">                return getSuccessor().handleFeeRequest(user, fee);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //先要组装责任链</div><div class="line">        Handler h1 = new GeneralManager();</div><div class="line">        Handler h2 = new DeptManager();</div><div class="line">        Handler h3 = new ProjectManager();</div><div class="line">        h3.setSuccessor(h2);</div><div class="line">        h2.setSuccessor(h1);</div><div class="line">        </div><div class="line">        //开始测试</div><div class="line">        String test1 = h3.handleFeeRequest(&quot;张三&quot;, 300);</div><div class="line">        System.out.println(&quot;test1 = &quot; + test1);</div><div class="line">        String test2 = h3.handleFeeRequest(&quot;李四&quot;, 300);</div><div class="line">        System.out.println(&quot;test2 = &quot; + test2);</div><div class="line">        System.out.println(&quot;---------------------------------------&quot;);</div><div class="line">        </div><div class="line">        String test3 = h3.handleFeeRequest(&quot;张三&quot;, 700);</div><div class="line">        System.out.println(&quot;test3 = &quot; + test3);</div><div class="line">        String test4 = h3.handleFeeRequest(&quot;李四&quot;, 700);</div><div class="line">        System.out.println(&quot;test4 = &quot; + test4);</div><div class="line">        System.out.println(&quot;---------------------------------------&quot;);</div><div class="line">        </div><div class="line">        String test5 = h3.handleFeeRequest(&quot;张三&quot;, 1500);</div><div class="line">        System.out.println(&quot;test5 = &quot; + test5);</div><div class="line">        String test6 = h3.handleFeeRequest(&quot;李四&quot;, 1500);</div><div class="line">        System.out.println(&quot;test6 = &quot; + test6);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/331652-e7f4c74390e25caa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="纯的与不纯的责任链模式"><a href="#纯的与不纯的责任链模式" class="headerlink" title="纯的与不纯的责任链模式"></a>纯的与不纯的责任链模式</h3><p>　　一个纯的责任链模式要求一个具体的处理者对象只能在两个行为中选择一个：一是承担责任，二是把责任推给下家。不允许出现某一个具体处理者对象在承担了一部分责任后又 把责任向下传的情况。</p>
<p>　　在一个纯的责任链模式里面，一个请求必须被某一个处理者对象所接收；在一个不纯的责任链模式里面，一个请求可以最终不被任何接收端对象所接收。</p>
<p>　　纯的责任链模式的实际例子很难找到，一般看到的例子均是不纯的责任链模式的实现。有些人认为不纯的责任链根本不是责任链模式，这也许是有道理的。但是在实际的系统里，纯的责任链很难找到。如果坚持责任链不纯便不是责任链模式，那么责任链模式便不会有太大意义了。</p>
<h3 id="责任链模式在Tomcat中的应用"><a href="#责任链模式在Tomcat中的应用" class="headerlink" title="责任链模式在Tomcat中的应用"></a>责任链模式在Tomcat中的应用</h3><p>　　众所周知Tomcat中的Filter就是使用了责任链模式，创建一个Filter除了要在web.xml文件中做相应配置外，还需要实现javax.servlet.Filter接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class TestFilter implements Filter&#123;</div><div class="line"></div><div class="line">    public void doFilter(ServletRequest request, ServletResponse response,</div><div class="line">            FilterChain chain) throws IOException, ServletException &#123;</div><div class="line">        </div><div class="line">        chain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void destroy() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用DEBUG模式所看到的结果如下</p>
<p><img src="http://upload-images.jianshu.io/upload_images/331652-07e75a9409b1d394.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>　　其实在真正执行到TestFilter类之前，会经过很多Tomcat内部的类。顺带提一下其实Tomcat的容器设置也是责任链模式，注意被红色方框所圈中的类，从Engine到Host再到Context一直到Wrapper都是通过一个链传递请求。被绿色方框所圈中的地方有一个名为ApplicationFilterChain的类，ApplicationFilterChain类所扮演的就是抽象处理者角色，而具体处理者角色由各个Filter扮演。</p>
<p>　　第一个疑问是ApplicationFilterChain将所有的Filter存放在哪里？</p>
<p>　　答案是保存在ApplicationFilterChain类中的一个ApplicationFilterConfig对象的数组中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * Filters.</div><div class="line">  */</div><div class="line"> private ApplicationFilterConfig[] filters = </div><div class="line">     new ApplicationFilterConfig[0];</div></pre></td></tr></table></figure>
<p>　　那ApplicationFilterConfig对象又是什么呢？</p>
<p>　   ApplicationFilterConfig是一个Filter容器。以下是ApplicationFilterConfig类的声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Implementation of a &lt;code&gt;javax.servlet.FilterConfig&lt;/code&gt; useful in</div><div class="line"> * managing the filter instances instantiated when a web application</div><div class="line"> * is first started.</div><div class="line"> *</div><div class="line"> * @author Craig R. McClanahan</div><div class="line"> * @version $Id: ApplicationFilterConfig.java 1201569 2011-11-14 01:36:07Z kkolinko $</div><div class="line"> */</div></pre></td></tr></table></figure>
<p>　　当一个web应用首次启动时ApplicationFilterConfig会自动实例化，它会从该web应用的web.xml文件中读取配置的Filter的信息，然后装进该容器。</p>
<p>　　刚刚看到在ApplicationFilterChain类中所创建的ApplicationFilterConfig数组长度为零，那它是在什么时候被重新赋值的呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">private ApplicationFilterConfig[] filters = </div><div class="line">        new ApplicationFilterConfig[0];</div></pre></td></tr></table></figure>
<p>是在调用ApplicationFilterChain类的addFilter()方法时。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line">     * The int which gives the current number of filters in the chain.</div><div class="line">     */</div><div class="line">    private int n = 0;</div><div class="line"></div><div class="line"> public static final int INCREMENT = 10;</div><div class="line"></div><div class="line">void addFilter(ApplicationFilterConfig filterConfig) &#123;</div><div class="line"></div><div class="line">        // Prevent the same filter being added multiple times</div><div class="line">        for(ApplicationFilterConfig filter:filters)</div><div class="line">            if(filter==filterConfig)</div><div class="line">                return;</div><div class="line"></div><div class="line">        if (n == filters.length) &#123;</div><div class="line">            ApplicationFilterConfig[] newFilters =</div><div class="line">                new ApplicationFilterConfig[n + INCREMENT];</div><div class="line">            System.arraycopy(filters, 0, newFilters, 0, n);</div><div class="line">            filters = newFilters;</div><div class="line">        &#125;</div><div class="line">        filters[n++] = filterConfig;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>　　变量n用来记录当前过滤器链里面拥有的过滤器数目，默认情况下n等于0，ApplicationFilterConfig对象数组的长度也等于0，所以当第一次调用addFilter()方法时，if (n == filters.length)的条件成立，ApplicationFilterConfig数组长度被改变。之后filters[n++] = filterConfig;将变量filterConfig放入ApplicationFilterConfig数组中并将当前过滤器链里面拥有的过滤器数目+1。</p>
<p>　　那ApplicationFilterChain的addFilter()方法又是在什么地方被调用的呢？</p>
<p>　　是在ApplicationFilterFactory类的createFilterChain()方法中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">public ApplicationFilterChain createFilterChain</div><div class="line">        (ServletRequest request, Wrapper wrapper, Servlet servlet) &#123;</div><div class="line"></div><div class="line">        // get the dispatcher type</div><div class="line">        DispatcherType dispatcher = null; </div><div class="line">        if (request.getAttribute(DISPATCHER_TYPE_ATTR) != null) &#123;</div><div class="line">            dispatcher = (DispatcherType) request.getAttribute(DISPATCHER_TYPE_ATTR);</div><div class="line">        &#125;</div><div class="line">        String requestPath = null;</div><div class="line">        Object attribute = request.getAttribute(DISPATCHER_REQUEST_PATH_ATTR);</div><div class="line">        </div><div class="line">        if (attribute != null)&#123;</div><div class="line">            requestPath = attribute.toString();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // If there is no servlet to execute, return null</div><div class="line">        if (servlet == null)</div><div class="line">            return (null);</div><div class="line"></div><div class="line">        boolean comet = false;</div><div class="line">        </div><div class="line">        // Create and initialize a filter chain object</div><div class="line">        ApplicationFilterChain filterChain = null;</div><div class="line">        if (request instanceof Request) &#123;</div><div class="line">            Request req = (Request) request;</div><div class="line">            comet = req.isComet();</div><div class="line">            if (Globals.IS_SECURITY_ENABLED) &#123;</div><div class="line">                // Security: Do not recycle</div><div class="line">                filterChain = new ApplicationFilterChain();</div><div class="line">                if (comet) &#123;</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain();</div><div class="line">                if (filterChain == null) &#123;</div><div class="line">                    filterChain = new ApplicationFilterChain();</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // Request dispatcher in use</div><div class="line">            filterChain = new ApplicationFilterChain();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        filterChain.setServlet(servlet);</div><div class="line"></div><div class="line">        filterChain.setSupport</div><div class="line">            (((StandardWrapper)wrapper).getInstanceSupport());</div><div class="line"></div><div class="line">        // Acquire the filter mappings for this Context</div><div class="line">        StandardContext context = (StandardContext) wrapper.getParent();</div><div class="line">        FilterMap filterMaps[] = context.findFilterMaps();</div><div class="line"></div><div class="line">        // If there are no filter mappings, we are done</div><div class="line">        if ((filterMaps == null) || (filterMaps.length == 0))</div><div class="line">            return (filterChain);</div><div class="line"></div><div class="line">        // Acquire the information we will need to match filter mappings</div><div class="line">        String servletName = wrapper.getName();</div><div class="line"></div><div class="line">        // Add the relevant path-mapped filters to this filter chain</div><div class="line">        for (int i = 0; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            if (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            if (!matchFiltersURL(filterMaps[i], requestPath))</div><div class="line">                continue;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            if (filterConfig == null) &#123;</div><div class="line">                // FIXME - log configuration problem</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            boolean isCometFilter = false;</div><div class="line">            if (comet) &#123;</div><div class="line">                try &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() instanceof CometFilter;</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    // Note: The try catch is there because getFilter has a lot of </div><div class="line">                    // declared exceptions. However, the filter is allocated much</div><div class="line">                    // earlier</div><div class="line">                    Throwable t = ExceptionUtils.unwrapInvocationTargetException(e);</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                &#125;</div><div class="line">                if (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Add filters that match on servlet name second</div><div class="line">        for (int i = 0; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            if (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            if (!matchFiltersServlet(filterMaps[i], servletName))</div><div class="line">                continue;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            if (filterConfig == null) &#123;</div><div class="line">                // FIXME - log configuration problem</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            boolean isCometFilter = false;</div><div class="line">            if (comet) &#123;</div><div class="line">                try &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() instanceof CometFilter;</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    // Note: The try catch is there because getFilter has a lot of </div><div class="line">                    // declared exceptions. However, the filter is allocated much</div><div class="line">                    // earlier</div><div class="line">                &#125;</div><div class="line">                if (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Return the completed filter chain</div><div class="line">        return (filterChain);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>　　可以将如上代码分为两段，51行之前为第一段，51行之后为第二段。</p>
<p>　　第一段的主要目的是创建ApplicationFilterChain对象以及一些参数设置。</p>
<p>　　第二段的主要目的是从上下文中获取所有Filter信息，之后使用for循环遍历并调用filterChain.addFilter(filterConfig);将filterConfig放入ApplicationFilterChain对象的ApplicationFilterConfig数组中。</p>
<p>　　那ApplicationFilterFactory类的createFilterChain()方法又是在什么地方被调用的呢？<br>是在StandardWrapperValue类的invoke()方法中被调用的。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/331652-e88a1f2dc594974c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>由于invoke()方法较长，所以将很多地方省略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public final void invoke(Request request, Response response)</div><div class="line">        throws IOException, ServletException &#123;</div><div class="line">   ...省略中间代码</div><div class="line">　　　　 // Create the filter chain for this request</div><div class="line">        ApplicationFilterFactory factory =</div><div class="line">            ApplicationFilterFactory.getInstance();</div><div class="line">        ApplicationFilterChain filterChain =</div><div class="line">            factory.createFilterChain(request, wrapper, servlet);</div><div class="line">　　...省略中间代码</div><div class="line">         filterChain.doFilter(request.getRequest(), response.getResponse());</div><div class="line">　　...省略中间代码</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>那正常的流程应该是这样的：</p>
<p>　　在StandardWrapperValue类的invoke()方法中调用ApplicationFilterChai类的createFilterChain()方法———&gt;在ApplicationFilterChai类的createFilterChain()方法中调用ApplicationFilterChain类的addFilter()方法———&gt;在ApplicationFilterChain类的addFilter()方法中给ApplicationFilterConfig数组赋值。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/331652-d154e450c25ed053.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>　　根据上面的代码可以看出StandardWrapperValue类的invoke()方法在执行完createFilterChain()方法后，会继续执行ApplicationFilterChain类的doFilter()方法，然后在doFilter()方法中会调用internalDoFilter()方法。</p>
<p>　　以下是internalDoFilter()方法的部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">// Call the next filter if there is one</div><div class="line">        if (pos &lt; n) &#123;</div><div class="line">　　　　　　　//拿到下一个Filter，将指针向下移动一位</div><div class="line">            //pos它来标识当前ApplicationFilterChain（当前过滤器链）执行到哪个过滤器</div><div class="line">            ApplicationFilterConfig filterConfig = filters[pos++];</div><div class="line">            Filter filter = null;</div><div class="line">            try &#123;</div><div class="line">　　　　　　　　　 //获取当前指向的Filter的实例</div><div class="line">                filter = filterConfig.getFilter();</div><div class="line">                support.fireInstanceEvent(InstanceEvent.BEFORE_FILTER_EVENT,</div><div class="line">                                          filter, request, response);</div><div class="line">                </div><div class="line">                if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(</div><div class="line">                        filterConfig.getFilterDef().getAsyncSupported())) &#123;</div><div class="line">                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</div><div class="line">                            Boolean.FALSE);</div><div class="line">                &#125;</div><div class="line">                if( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">                    final ServletRequest req = request;</div><div class="line">                    final ServletResponse res = response;</div><div class="line">                    Principal principal = </div><div class="line">                        ((HttpServletRequest) req).getUserPrincipal();</div><div class="line"></div><div class="line">                    Object[] args = new Object[]&#123;req, res, this&#125;;</div><div class="line">                    SecurityUtil.doAsPrivilege</div><div class="line">                        (&quot;doFilter&quot;, filter, classType, args, principal);</div><div class="line">                    </div><div class="line">                &#125; else &#123;</div><div class="line">　　　　　　　　　　　　//调用Filter的doFilter()方法  </div><div class="line">                    filter.doFilter(request, response, this);</div><div class="line">                &#125;</div></pre></td></tr></table></figure>
<p>　　这里的filter.doFilter(request, response, this);就是调用我们前面创建的TestFilter中的doFilter()方法。而TestFilter中的doFilter()方法会继续调用chain.doFilter(request, response);方法，而这个chain其实就是ApplicationFilterChain,所以调用过程又回到了上面调用dofilter和调用internalDoFilter方法，这样执行直到里面的过滤器全部执行。</p>
<p>　　如果定义两个过滤器，则Debug结果如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/331652-d2b6a199504853e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #0097A7 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #0097A7 !important;
    }
    #ds-reset .ds-highlight {
        color: #0097A7 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread"
        data-thread-key=""
        data-url="https://lijunyu.github.io/2017/04/22/设计模式-责任链模式/"
        data-title="设计模式-责任链模式">
    </div>
    <!-- 多说评论框 end -->
</div>





                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/05/02/打开的文件过多/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/03/27/立体按钮/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar/me.png" alt="Yoo's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        mlijunyu@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto:mlijunyu@gmail.com" target="_blank" title="Email Me">
                        <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
            主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
    <!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
    -->

    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">6</span></a>
        </ul>
    </li>

    <!-- Categories  -->
    

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
  	
        <li>
            <a href="/about/" title="关于我">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于我
            </a>
        </li>
  	
        <li>
            <a href="/links/" title="小伙伴们">
                
                    <i class="material-icons sidebar-material-icons">group</i>
                
                小伙伴们
            </a>
        </li>
  	
        <li>
            <a href="/gallery/" title="图库">
                
                    <i class="material-icons sidebar-material-icons">view_quilt</i>
                
                图库
            </a>
        </li>
  	
        <li>
            <a href="/tags/" title="标签云">
                
                    <i class="material-icons sidebar-material-icons">cloud</i>
                
                标签云
            </a>
        </li>
  	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
            文章总数
            <span class="sidebar-badge">26</span>
        </a>
    </li>
</ul>


        <!-- Sidebar Divider -->
        <div class="sidebar-divider"></div>

        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        主题 - Material
        <span class="sidebar-badge badge-circle">i</span>
    </div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
    sidebar.help
    <span class="mdl-button__ripple-container">
      <span class="mdl-ripple"></span>
    </span>
  </div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

    </div>

    <!-- Sidebar Sponsor -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="http://www.weibo.com/u/1596882431" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-weibo.png);">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/lijunyu" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/zhihujiaozi" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-zhihu.png);">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;八月份的饺子
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();

    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });

    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    <script src="/js/smoothscroll.js"></script>



    <!-- Leancloud -->
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>
        AV.initialize("y4lpwyNmQR4WuErcQKh1WRUX-gzGzoHsz", "KBe9yF8VpXgsigh2JxKtRmw8");
    </script>
    <script>
    function showTime(Counter) {
        var query = new AV.Query(Counter);
        $('.leancloud-views_num').each(function() {
            var url = $(this).attr('id').trim();
            query.equalTo('url', url);
            query.find({
                success: function(results) {
                    if (results.length === 0) {
                        var content = '0 ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                        return;
                    }
                    for (var i = 0; i < results.length; i++) {
                        var object = results[i];
                        var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    }
                },
                error: function(object, error) {
                    console.log('Error: ' + error.code + ' ' + error.message);
                }
            });
        });
    }

    function addCount(Counter) {
      var Counter = AV.Object.extend('Counter');
      url = $('.leancloud-views_num').attr('id').trim();
      title = $('.leancloud-views_num').attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo('url', url);
      query.find({
          success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment('time');
                counter.save(null, {
                    success: function(counter) {
                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
              var newcounter = new Counter();
              newcounter.set('title', title);
              newcounter.set('url', url);
              newcounter.set('time', 1);
              newcounter.save(null, {
                  success: function(newcounter) {
                      console.log('newcounter.get(\'time\')='+newcounter.get('time'));
                      var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
                      $(document.getElementById(url)).text(content);
                  },
                  error: function(newcounter, error) {
                      console.log('Failed to create');
                  }
              });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + ' ' + error.message);
        }
      });
    }
    $(function() {
        var Counter = AV.Object.extend('Counter');
        if ($('.leancloud-views_num').length === 1) {
            addCount(Counter);
        } else if ($('.post-title-link').length > 1) {
            showTime(Counter);
        }
    });
</script>




    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: 'null'
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0]
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->





<!-- Swiftye -->


<!-- Local Search-->

    <script>
    var searchFunc = function(path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: 'xml',
            success: function( xmlResponse ) {
                // get the contents from search data
                var datas = $( 'entry', xmlResponse ).map(function() {
                    return {
                        title: $( 'title', this ).text(),
                        content: $('content',this).text(),
                        url: $( 'url' , this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function() {
                    var str='<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function(data) {
                        var isMatch = true;
                        var content_index = [];
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                        var data_url = data.url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if(data_title != '' && data_content != '') {
                            keywords.forEach(function(keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if( index_title < 0 && index_content < 0 ) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += '<li><a href="'+ data_url +'" class="search-result-title" target="_blank">'+ data_title;
                            var content = data.content.trim().replace(/<[^>]+>/g, '');
                            if (first_occur >= 0) {
                                // cut out characters
                                var start = first_occur - 6;
                                var end = first_occur + 6;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 10;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, 'gi');
                                    match_content = match_content.replace(regS, '<em class="search-keyword">'+keyword+'</em>');
                                })
                                str += '<p class="search-result">' + match_content +'...</p>' +'</a>';
                            }
                        }
                    });
                    $resultContent.innerHTML = str;
                });
            }
        });
    }
</script>


    <script>
        var inputArea = document.querySelector('#search');
        var getSearchFile = function() {
            var path = 'search.xml';
            searchFunc(path, 'search', 'local-search-result');
        }

        if(inputArea) {
            inputArea.onfocus = function() {
                getSearchFile();
            }
        }
    </script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
